<!-- ENHANCED: Premium my_analyses.html -->
{% extends "property_ai/base.html" %}

{% block title %}Investment Dashboard{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Dashboard Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-4 fw-bold mb-2">
                Investment Dashboard
            </h1>
            <p class="lead text-muted mb-0">
                Track and manage your property analyses
            </p>
        </div>
        <a href="{% url 'property_ai:analyze_property' %}" class="btn btn-primary btn-lg">
            <i class="bi bi-plus-lg me-2"></i>
            New Analysis
        </a>
    </div>

    <!-- Stats Overview -->
    {% if stats.total > 0 %}
    <div class="card border-primary border-opacity-25 bg-primary bg-opacity-5 fade-in mb-4">
        <div class="card-body p-4">
            <h2 class="text-center mb-4">Portfolio Overview</h2>
            <div class="row g-4">
                <div class="col-lg-3 col-md-6">
                    <div class="text-center">
                        <div class="h2 fw-bold text-primary mb-2">{{ stats.total }}</div>
                        <div class="text-muted">Total Properties</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="text-center">
                        <div class="h2 fw-bold text-primary mb-2">{{ stats.completed }}</div>
                        <div class="text-muted">Analyzed</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="text-center">
                        <div class="h2 fw-bold text-primary mb-2">{{ stats.avg_score|floatformat:1|default:"N/A" }}</div>
                        <div class="text-muted">Average Score</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="text-center">
                        <div class="h2 fw-bold text-primary mb-2">{{ stats.strong_buys }}</div>
                        <div class="text-muted">Strong Buys</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tier Info -->
    {% if user_tier %}
    <div class="alert alert-info fade-in mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>{{ user_tier|title }} Plan</strong> • 
                Showing your {{ stats.total }} personal analyses
                {% if user_tier != 'premium' %}
                    • {{ remaining_analyses }} analyses remaining this month
                {% endif %}
            </div>
            {% if user_tier == 'free' %}
                <a href="#upgrade" class="btn btn-success btn-sm">Upgrade to Basic - €5</a>
            {% elif user_tier == 'basic' %}
                <a href="#upgrade" class="btn btn-warning btn-sm">Upgrade to Premium - €15</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if analyses %}
    <!-- Properties Grid -->
    <div class="row g-4">
        {% for analysis in analyses %}
        <div class="col-lg-6 col-xl-4">
            <div class="card h-100 fade-in" style="animation-delay: {{ forloop.counter0|floatformat:1|add:'0.1' }}s; transition: all 0.3s ease; {% if not analysis.is_active %}opacity: 0.8; border-left: 4px solid var(--bs-warning);{% endif %}">
                <div class="card-body p-4">
                    <!-- Status & Score Header -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex gap-2">
                            {% if analysis.status == 'completed' %}
                                <span class="badge bg-success">Completed</span>
                            {% elif analysis.status == 'failed' %}
                                <span class="badge bg-danger">Failed</span>
                            {% elif analysis.status == 'analyzing' %}
                                <span class="badge bg-warning">Analyzing</span>
                            {% endif %}
                            
                            {% if not analysis.is_active %}
                                <span class="badge bg-warning">Removed</span>
                            {% endif %}
                        </div>
                        
                        {% if analysis.investment_score %}
                        <div class="text-center">
                            <div class="rounded-circle d-flex align-items-center justify-content-center fw-bold text-white small" style="width: 50px; height: 50px; background: {% if analysis.investment_score >= 80 %}var(--bs-success){% elif analysis.investment_score >= 60 %}var(--bs-primary){% else %}var(--bs-warning){% endif %};">
                                {{ analysis.investment_score }}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Property Title & Location -->
                    <h3 class="h5 mb-2 lh-sm">
                        {{ analysis.property_title|truncatechars:50 }}
                    </h3>
                    
                    <div class="text-muted mb-3 d-flex align-items-center gap-2">
                        <i class="bi bi-geo-alt"></i>
                        <span>{{ analysis.property_location }}</span>
                        {% if analysis.neighborhood %}
                            <span>•</span>
                            <span>{{ analysis.neighborhood }}</span>
                        {% endif %}
                    </div>

                    <!-- Property Stats -->
                    <div class="bg-light rounded p-3 mb-3">
                        <div class="row g-3 text-center">
                            <div class="col-4">
                                <div class="fw-bold text-primary small mb-1">
                                    €{{ analysis.asking_price|floatformat:0 }}
                                </div>
                                <div class="text-muted small">Price</div>
                            </div>
                            
                            {% if analysis.usable_area %}
                            <div class="col-4">
                                <div class="fw-bold small mb-1">
                                    {{ analysis.usable_area }}m²
                                </div>
                                <div class="text-muted small">Area</div>
                            </div>
                            {% endif %}
                            
                            {% if analysis.price_per_sqm %}
                            <div class="col-4">
                                <div class="fw-bold small mb-1">
                                    €{{ analysis.price_per_sqm|floatformat:0 }}
                                </div>
                                <div class="text-muted small">per m²</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Recommendation Badge -->
                    {% if analysis.recommendation and analysis.status == 'completed' %}
                    <div class="text-center mb-3">
                        {% if analysis.recommendation == 'strong_buy' %}
                            <span class="badge bg-success px-3 py-2">Strong Buy</span>
                        {% elif analysis.recommendation == 'buy' %}
                            <span class="badge bg-primary px-3 py-2">Buy</span>
                        {% elif analysis.recommendation == 'hold' %}
                            <span class="badge bg-warning px-3 py-2">Hold</span>
                        {% elif analysis.recommendation == 'avoid' %}
                            <span class="badge bg-danger px-3 py-2">Avoid</span>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Property Meta -->
                    <div class="mb-3 small text-muted">
                       <div class="d-flex justify-content-between mb-1">
                           <span>{{ analysis.property_type|title }}</span>
                           {% if analysis.property_condition %}
                               <span>{{ analysis.property_condition|title }}</span>
                           {% endif %}
                       </div>
                       
                       <div class="d-flex justify-content-between">
                           <span>{{ analysis.days_on_market }} days on market</span>
                           <span>{{ analysis.created_at|date:"M j" }}</span>
                       </div>
                       
                       {% if not analysis.is_active %}
                       <div class="text-warning mt-2 d-flex align-items-center gap-2">
                           <i class="bi bi-exclamation-triangle"></i>
                           <span>Removed {{ analysis.removed_date|timesince }} ago</span>
                       </div>
                       {% endif %}
                   </div>

                   <!-- Action Buttons -->
                   <div class="d-flex justify-content-between align-items-center">
                       <div class="small text-muted">
                           {{ analysis.created_at|date:"M j, Y" }}
                       </div>
                       <div class="d-flex gap-2">
                           <a href="{% url 'property_ai:analysis_detail' analysis_id=analysis.id %}" 
                              class="btn btn-outline-secondary btn-sm">
                               <i class="bi bi-eye me-1"></i>
                               View
                           </a>
                           {% if analysis.report_generated and analysis.report_file_path %}
                               <a href="{% url 'property_ai:download_report' analysis_id=analysis.id %}" 
                                  class="btn btn-primary btn-sm">
                                   <i class="bi bi-file-earmark-text me-1"></i>
                                   PDF
                               </a>
                           {% endif %}
                       </div>
                   </div>
               </div>
           </div>
       </div>
       {% endfor %}
   </div>
   
   {% else %}
   <!-- Empty State -->
   <div class="card text-center py-5">
       <div class="card-body fade-in">
           <div class="display-1 mb-4 opacity-50">🏢</div>
           <h2 class="display-6 fw-bold mb-4">
               No Properties Yet
           </h2>
           <p class="lead text-muted mb-5 mx-auto" style="max-width: 500px;">
               Start analyzing Albanian properties to get AI-powered investment insights and build your portfolio.
           </p>
           
           <div class="card border-primary border-opacity-25 bg-primary bg-opacity-5 mx-auto mb-5" style="max-width: 600px;">
               <div class="card-body">
                   <h3 class="mb-4">What you'll get:</h3>
                   <div class="row g-3 text-start">
                       <div class="col-md-6">
                           <div class="d-flex align-items-center gap-2">
                               <i class="bi bi-check-circle-fill text-success"></i>
                               <span>Investment scoring (0-100)</span>
                           </div>
                       </div>
                       <div class="col-md-6">
                           <div class="d-flex align-items-center gap-2">
                               <i class="bi bi-check-circle-fill text-success"></i>
                               <span>Market position analysis</span>
                           </div>
                       </div>
                       <div class="col-md-6">
                           <div class="d-flex align-items-center gap-2">
                               <i class="bi bi-check-circle-fill text-success"></i>
                               <span>Rental yield estimates</span>
                           </div>
                       </div>
                       <div class="col-md-6">
                           <div class="d-flex align-items-center gap-2">
                               <i class="bi bi-check-circle-fill text-success"></i>
                               <span>Professional recommendations</span>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
           
           <a href="{% url 'property_ai:analyze_property' %}" class="btn btn-primary btn-lg">
               <i class="bi bi-plus-lg me-2"></i>
               Analyze Your First Property
           </a>
       </div>
   </div>
   {% endif %}
</div>
{% endblock %}