{% extends 'property_ai/base.html' %}
{% load static %}

{% block title %}Analytics Dashboard - Property AI{% endblock %}

{% block extra_css %}
<style>
    .analytics-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-neutral { color: #6c757d; }
    
    .market-sentiment {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }
    
    .sentiment-bullish { background: #d4edda; color: #155724; }
    .sentiment-bearish { background: #f8d7da; color: #721c24; }
    .sentiment-neutral { background: #e2e3e5; color: #383d41; }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .opportunity-score {
        font-size: 3rem;
        font-weight: 900;
        text-align: center;
        margin: 1rem 0;
    }
    
    .score-excellent { color: #28a745; }
    .score-good { color: #17a2b8; }
    .score-fair { color: #ffc107; }
    .score-poor { color: #dc3545; }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-completed { background: #d4edda; color: #155724; }
    .status-analyzing { background: #fff3cd; color: #856404; }
    .status-failed { background: #f8d7da; color: #721c24; }
    
    .analysis-note {
        background: #e7f3ff;
        border-left: 4px solid #17a2b8;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="analytics-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">üìä Analytics Dashboard</h1>
                <p class="mb-0 opacity-75">Comprehensive market insights and portfolio analytics</p>
            </div>
            <div class="col-md-4 text-end">
                <span class="badge bg-light text-dark fs-6">Tier: {{ user_tier|title }}</span>
            </div>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        {{ error }}
    </div>
    {% endif %}

    <!-- Portfolio Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">üìà Portfolio Overview</h3>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ portfolio_stats.total_analyses|default:0 }}</div>
                <div class="stat-label">Total Properties</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ portfolio_stats.completed_analyses|default:0 }}</div>
                <div class="stat-label">Completed Analyses</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ portfolio_stats.avg_investment_score|default:0|floatformat:1 }}</div>
                <div class="stat-label">Avg Investment Score</div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ portfolio_stats.strong_buys|default:0 }}</div>
                <div class="stat-label">Strong Buy Recommendations</div>
            </div>
        </div>
    </div>

    <!-- Analysis Status Breakdown -->
    {% if status_breakdown %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">üìã Analysis Status</h3>
        </div>
        
        <div class="col-md-3">
            <div class="chart-container text-center">
                <div class="stat-number status-completed">{{ status_breakdown.completed }}</div>
                <div class="stat-label">Completed</div>
                <span class="status-badge status-completed">‚úì Ready</span>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="chart-container text-center">
                <div class="stat-number status-analyzing">{{ status_breakdown.analyzing }}</div>
                <div class="stat-label">Analyzing</div>
                <span class="status-badge status-analyzing">‚è≥ Processing</span>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="chart-container text-center">
                <div class="stat-number status-failed">{{ status_breakdown.failed }}</div>
                <div class="stat-label">Failed</div>
                <span class="status-badge status-failed">‚ùå Error</span>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="chart-container text-center">
                <div class="stat-number">{{ status_breakdown.completion_rate|floatformat:1 }}%</div>
                <div class="stat-label">Completion Rate</div>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: {{ status_breakdown.completion_rate }}%"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Market Summary -->
    {% if market_summary.market_stats %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">üè† Market Summary</h3>
        </div>
        
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3">Market Statistics</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="stat-number">{{ market_summary.market_stats.total_properties|default:0 }}</div>
                        <div class="stat-label">Total Properties</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number">‚Ç¨{{ market_summary.market_stats.avg_price|default:0|floatformat:0 }}</div>
                        <div class="stat-label">Average Price</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="stat-number">{{ market_summary.market_stats.avg_investment_score|default:0|floatformat:1 }}</div>
                        <div class="stat-label">Avg Investment Score</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number">{{ market_summary.market_stats.analysis_completion_rate|default:0|floatformat:1 }}%</div>
                        <div class="stat-label">Analysis Completion</div>
                    </div>
                </div>
                
                {% if market_summary.market_stats.analysis_completion_rate < 100 %}
                <div class="analysis-note mt-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Note:</strong> {{ market_summary.market_stats.analyzing_count|default:0 }} properties are currently being analyzed. 
                    Basic metrics are available for unanalyzed properties.
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3">Property Type Distribution</h5>
                {% if market_summary.type_distribution %}
                    {% for type_data in market_summary.type_distribution|slice:":5" %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-capitalize">{{ type_data.property_type|default:"Unknown" }}</span>
                        <div>
                            <span class="badge bg-primary">{{ type_data.count }}</span>
                            {% if type_data.completed_count %}
                            <small class="text-muted ms-1">({{ type_data.completed_count }} analyzed)</small>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No property type data available</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Location Analysis -->
    {% if location_stats %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">üìç Location Analysis</h3>
        </div>
        
        {% for location_data in location_stats %}
        <div class="col-md-6 col-lg-4">
            <div class="chart-container">
                <h6 class="mb-2">{{ location_data.property_location }}</h6>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stat-number">{{ location_data.count }}</div>
                        <div class="stat-label">Properties</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-number">{{ location_data.avg_score|default:0|floatformat:1 }}</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-number">‚Ç¨{{ location_data.avg_price|default:0|floatformat:0 }}</div>
                        <div class="stat-label">Avg Price</div>
                    </div>
                </div>
                {% if location_data.completed_count %}
                <div class="text-center mt-2">
                    <small class="text-muted">{{ location_data.completed_count }} of {{ location_data.count }} analyzed</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Property Type Analysis -->
    {% if type_stats %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">üèòÔ∏è Property Type Analysis</h3>
        </div>
        
        {% for type_data in type_stats %}
        <div class="col-md-6 col-lg-4">
            <div class="chart-container">
                <h6 class="mb-2 text-capitalize">{{ type_data.property_type|default:"Unknown" }}</h6>
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stat-number">{{ type_data.count }}</div>
                        <div class="stat-label">Count</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-number">{{ type_data.avg_score|default:0|floatformat:1 }}</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                    <div class="col-4">
                        <div class="stat-number">‚Ç¨{{ type_data.avg_price|default:0|floatformat:0 }}</div>
                        <div class="stat-label">Avg Price</div>
                    </div>
                </div>
                {% if type_data.completed_count %}
                <div class="text-center mt-2">
                    <small class="text-muted">{{ type_data.completed_count }} of {{ type_data.count }} analyzed</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Recent Market Trends -->
    {% if recent_trends %}
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">üìà Recent Market Trends</h3>
        </div>
        
        {% for trend_data in recent_trends %}
        <div class="col-md-6">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">{{ trend_data.property|truncatechars:40 }}</h6>
                    <span class="status-badge status-{{ trend_data.status }}">{{ trend_data.status|title }}</span>
                </div>
                <small class="text-muted">{{ trend_data.location }}</small>
                
                {% if trend_data.trends %}
                <div class="mt-3">
                    <h6 class="text-muted">Price Trends (Last 3 months)</h6>
                    {% for trend in trend_data.trends|slice:":3" %}
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>{{ trend.month|date:"M Y" }}</span>
                        <span>‚Ç¨{{ trend.avg_price|floatformat:0 }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Market Insights -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="h4 mb-3">üí° Market Insights</h3>
        </div>
        
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3">Investment Opportunities</h5>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stat-number trend-up">{{ portfolio_stats.high_leverage_count|default:0 }}</div>
                        <div class="stat-label">High Leverage</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number trend-up">{{ portfolio_stats.below_market_count|default:0 }}</div>
                        <div class="stat-label">Below Market</div>
                    </div>
                </div>
                {% if portfolio_stats.basic_opportunity_count %}
                <div class="text-center mt-3">
                    <div class="stat-number trend-up">{{ portfolio_stats.basic_opportunity_count }}</div>
                    <div class="stat-label">Basic Opportunities</div>
                    <small class="text-muted">(Unanalyzed properties with potential)</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3">Market Recommendations</h5>
                {% if portfolio_stats.avg_investment_score >= 75 %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i>
                        <strong>Strong Market:</strong> High average scores indicate good investment opportunities
                    </div>
                {% elif portfolio_stats.avg_investment_score >= 60 %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Moderate Market:</strong> Mixed conditions, selective investing recommended
                    </div>
                {% elif portfolio_stats.avg_investment_score %}
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i>
                        <strong>Challenging Market:</strong> Low scores suggest waiting for better opportunities
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Analysis in Progress:</strong> Complete analysis of properties to get detailed insights
                    </div>
                {% endif %}
                
                {% if portfolio_stats.analyzing_count > 0 %}
                <div class="alert alert-warning mt-2">
                    <i class="bi bi-clock"></i>
                    <strong>{{ portfolio_stats.analyzing_count }} properties</strong> are currently being analyzed. 
                    Check back soon for updated insights.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="mb-3">üöÄ Quick Actions</h5>
                <div class="row">
                    <div class="col-md-4">
                        <a href="{% url 'property_ai:analyze_property' %}" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-plus-circle"></i> Analyze New Property
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{% url 'property_ai:my_analyses' %}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-list-ul"></i> View My Analyses
                        </a>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-secondary w-100 mb-2" onclick="refreshAnalytics()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="position-fixed top-50 start-50 translate-middle" style="display: none; z-index: 9999;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshAnalytics() {
    const spinner = document.getElementById('loading-spinner');
    spinner.style.display = 'block';
    
    // Reload the page to refresh analytics
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

// Auto-refresh every 5 minutes
setTimeout(() => {
    console.log('Auto-refreshing analytics data...');
    refreshAnalytics();
}, 300000); // 5 minutes

// Add smooth scrolling for better UX
document.addEventListener('DOMContentLoaded', function() {
    // Smooth scroll to top when clicking refresh
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
});
</script>
{% endblock %}

