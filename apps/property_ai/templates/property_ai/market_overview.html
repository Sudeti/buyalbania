{% extends "property_ai/base.html" %}
{% load static %}

{% block title %}Albanian Real Estate Market Overview{% endblock %}

{% block extra_css %}
<style>
    .market-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
        margin-bottom: 3rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .market-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .location-item, .type-item, .opportunity-item {
        background: #f8fafc;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
    }
    
    .opportunity-item {
        border-left-color: #10b981;
    }
    
    .price-trend {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .trend-up {
        color: #10b981;
    }
    
    .trend-down {
        color: #ef4444;
    }
    
    .velocity-indicator {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .chart-placeholder {
        background: #f8fafc;
        border: 2px dashed #d1d5db;
        border-radius: 10px;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Market Hero -->
<div class="market-hero">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-4">Albanian Real Estate Market Overview</h1>
                <p class="lead">AI-powered insights from {{ total_properties }} analyzed properties across Albania</p>
                <p class="text-light">Last updated: {% now "F j, Y" %}</p>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Market Statistics -->
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ total_properties|default:0 }}</div>
                <div class="stat-label">Properties Analyzed</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ total_removed|default:0 }}</div>
                <div class="stat-label">Properties Sold/Removed</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ avg_days_on_market|default:0 }}</div>
                <div class="stat-label">Avg Days on Market</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number">{{ recently_removed|default:0 }}</div>
                <div class="stat-label">Removed This Month</div>
            </div>
        </div>
    </div>
    {% if analysis.market_position.city_comparison %}
<div class="market-position">
    <h3>Market Position</h3>
    
    <div class="city-comparison">
        <strong>City Average:</strong> ‚Ç¨{{ analysis.market_position.city_comparison.market_avg_per_sqm|floatformat:0 }}/m¬≤<br>
        <strong>This Property:</strong> ‚Ç¨{{ analysis.price_per_sqm|floatformat:0 }}/m¬≤<br>
        
        {% if analysis.market_position.city_comparison.is_below_market %}
            <span class="below-market">
                ‚úÖ {{ analysis.market_position.city_comparison.difference_percentage|floatformat:1|add:"%" }} BELOW market average
            </span>
        {% else %}
            <span class="above-market">
                ‚ö†Ô∏è {{ analysis.market_position.city_comparison.difference_percentage|floatformat:1|add:"%" }} ABOVE market average
            </span>
        {% endif %}
    </div>
</div>
{% endif %}
{% if user.is_authenticated %}
    <div class="alert alert-primary">
        <div class="row align-items-center">
            <div class="col-md-8">
                <strong>{{ tier_message }}</strong>
            </div>
            <div class="col-md-4 text-end">
                {% if user_tier == 'free' %}
                    <a href="#upgrade" class="btn btn-success btn-sm">Upgrade to Basic</a>
                {% elif user_tier == 'basic' %}
                    <a href="#upgrade" class="btn btn-warning btn-sm">Upgrade to Premium</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% elif user_tier == 'anonymous' %}
    <div class="alert alert-info text-center">
        <h5>üè† See Individual Property Analyses</h5>
        <p>{{ tier_message }}</p>
        <a href="{% url 'accounts:register' %}" class="btn btn-primary me-2">Sign Up Free</a>
        <a href="{% url 'accounts:login' %}" class="btn btn-outline-primary">Login</a>
    </div>
    {% endif %}

    <!-- Market Velocity Indicator -->
    <div class="velocity-indicator">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5><i class="fas fa-tachometer-alt me-2"></i>Market Velocity</h5>
                <p class="mb-0">
                    {% if avg_days_on_market <= 30 %}
                        <span class="text-success fw-bold">Fast Moving Market</span> - Properties selling quickly
                    {% elif avg_days_on_market <= 60 %}
                        <span class="text-warning fw-bold">Moderate Market</span> - Normal selling pace
                    {% else %}
                        <span class="text-danger fw-bold">Slow Market</span> - Properties taking longer to sell
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                <i class="fas fa-chart-line fa-2x text-warning"></i>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Top Locations -->
        <div class="col-lg-6">
            <div class="market-section">
                <h2><i class="fas fa-map-marker-alt me-2"></i>Top Markets by Activity</h2>
                {% if location_stats %}
                    {% for location in location_stats %}
                    <div class="location-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">{{ location.property_location|title }}</h5>
                                <small class="text-muted">{{ location.count }} properties analyzed</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">‚Ç¨{{ location.avg_price|floatformat:0 }}</div>
                                <small class="text-muted">Avg Price</small>
                                {% if location.avg_score %}
                                <div class="mt-1">
                                    <span class="badge bg-primary">{{ location.avg_score|floatformat:1 }} Score</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No location data available yet.</p>
                {% endif %}
            </div>
        </div>

        <!-- Property Types -->
        <div class="col-lg-6">
            <div class="market-section">
                <h2><i class="fas fa-building me-2"></i>Property Types</h2>
                {% if type_stats %}
                    {% for type in type_stats %}
                    <div class="type-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">{{ type.property_type|title }}</h5>
                                <small class="text-muted">{{ type.count }} properties</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">‚Ç¨{{ type.avg_price|floatformat:0 }}</div>
                                <small class="text-muted">Avg Price</small>
                                {% if type.avg_score %}
                                <div class="mt-1">
                                    <span class="badge bg-secondary">{{ type.avg_score|floatformat:1 }} Score</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No property type data available yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Top Investment Opportunities -->
    <div class="market-section">
        <h2><i class="fas fa-star me-2"></i>Top Investment Opportunities</h2>
        <p class="text-muted mb-4">Properties with highest AI investment scores (75+)</p>
        
        {% if top_opportunities %}
        <div class="row">
            {% for opportunity in top_opportunities %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="opportunity-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">{{ opportunity.property_title|truncatechars:40 }}</h6>
                        <span class="badge bg-success">{{ opportunity.investment_score }}</span>
                    </div>
                    <p class="text-muted mb-2">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ opportunity.property_location }}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">‚Ç¨{{ opportunity.asking_price|floatformat:0 }}</div>
                            {% if opportunity.square_meters %}
                            <small class="text-muted">{{ opportunity.square_meters }} m¬≤</small>
                            {% endif %}
                        </div>
                        <div>
                            <a href="{% url 'property_ai:analysis_detail' analysis_id=opportunity.id %}" 
                               class="btn btn-outline-success btn-sm">
                                View Analysis
                            </a>
                        </div>
                    </div>
                    
                    <!-- Days on market indicator -->
                    <div class="mt-2">
                        <small class="text-muted">
                            {% if not opportunity.is_active %}
                                <i class="fas fa-times-circle text-danger me-1"></i>Removed after {{ opportunity.days_on_market }} days
                            {% else %}
                                <i class="fas fa-clock me-1"></i>{{ opportunity.days_on_market }} days on market
                            {% endif %}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <p class="text-muted">No high-scoring investment opportunities available yet.</p>
            <a href="{% url 'property_ai:analyze_property' %}" class="btn btn-primary">
                Start Analyzing Properties
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Market Trends Chart Placeholder -->
    <div class="market-section">
        <h2><i class="fas fa-chart-area me-2"></i>Price Trends</h2>
        <div class="chart-placeholder">
            <div class="text-center">
                <i class="fas fa-chart-line fa-3x mb-3"></i>
                <p>Price trend charts coming soon</p>
                <small class="text-muted">Historical price data will be displayed here</small>
            </div>
        </div>
    </div>

    <!-- Market Insights -->
    <div class="market-section">
        <h2><i class="fas fa-lightbulb me-2"></i>Market Insights</h2>
        <div class="row">
            <div class="col-md-6">
                <h5>Key Trends</h5>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-arrow-up text-success me-2"></i>
                        Strong demand in Tirana center
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-arrow-right text-warning me-2"></i>
                        Stable prices in Durr√´s coastal areas
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-arrow-up text-success me-2"></i>
                        Growing interest in commercial properties
                    </li>
                    {% if avg_days_on_market <= 45 %}
                    <li class="mb-2">
                        <i class="fas fa-clock text-info me-2"></i>
                        Fast-moving market conditions
                    </li>
                    {% endif %}
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Investment Tips</h5>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Focus on properties with 70+ AI scores
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Consider ground floor commercial spaces
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        New properties typically score higher
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Monitor properties for 2-3 weeks
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Call to Action -->
    <div class="text-center py-5">
        <h3>Start Your Property Analysis</h3>
        <p class="text-muted mb-4">Get AI-powered investment insights for any Albanian property</p>
        <a href="{% url 'property_ai:analyze_property' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-plus me-2"></i>Analyze Property
        </a>
    </div>
</div>
{% endblock %}